<!DOCTYPE html>
<html lang="ky">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CAPI ‚Äî 100% —Ç–∞–±–∏–≥—ã–π –ø—Ä–æ–¥—É–∫—Ü–∏—è</title>
  <meta name="theme-color" content="#d86916"/>

  <style>
    /* ‚Äî‚Äî‚Äî Base ‚Äî‚Äî‚Äî */
    :root{
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body {
      background-color: #fff8e1;
      color: #4e342e;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      padding-top: max(0px, var(--safe-top));
      padding-bottom: max(0px, var(--safe-bottom));
    }
    header {
      background-color: #ffcc80;
      padding: 15px;
      text-align: center;
    }
    h1 { margin: 0; font-size: 2.0em; color: #4e342e; }
    #slogan { font-size: 1em; color: #5d4037; margin-top: 5px; }

    button {
      background-color: #ffb300; color: white; border: none;
      padding: 10px 14px; border-radius: 6px; font-size: 1em;
      cursor: pointer; margin-top: 8px; transition: transform .04s ease; touch-action: manipulation;
    }
    button:active { transform: scale(.98); }
    button:hover { background-color: #ffa000; }

    /* ‚Äî‚Äî‚Äî Productos ‚Äî‚Äî‚Äî */
    #product-list {
      display: flex; flex-wrap: wrap; justify-content: center;
      padding: 20px; gap: 12px;
    }
    .product {
      background-color: #ffffff; border: 1px solid #ffe0b2; border-radius: 8px;
      padding: 20px; margin: 12px; text-align: center;
      width: 260px; max-width: 92vw;
    }
    .product h2 { margin: 8px 0 6px; font-size: 1.1em; color: #4e342e; }
    .size-selector { margin: 6px 0 8px; }
    .price-label { color: #5d4037; margin: 4px 0 8px; }

    /* ‚Äî‚Äî‚Äî Carrito flotante ‚Äî‚Äî‚Äî */
    #cart-popup {
      background-color: #fff8e1; border: 2px solid #ffe0b2; padding: 20px;
      position: fixed; bottom: 80px; right: 20px; z-index: 999; width: 300px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-radius: 10px;
      transition: opacity 0.25s ease, transform 0.25s ease; opacity: 1; transform: translateY(0);
    }
    #cart-popup.hidden { opacity: 0; transform: translateY(20px); pointer-events: none; display: block; }
    .hidden { display: none; }

    #cart-button {
      position: fixed; bottom: 20px; right: 20px; background-color: #ffb300; color: white;
      border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 1000;
    }
    #cart-count {
      position: absolute; top: -6px; right: -6px; background-color: red; color: white;
      border-radius: 50%; padding: 2px 6px; font-size: 14px; display: none;
    }
  </style>

  <!-- OVERRIDE im√°genes: agranda el recuadro y la imagen calza completa -->
  <style id="imgfix-override">
    #product-list .product img,
    .product img,
    img.product-image {
      height: 300px !important;     /* ‚Üê ajusta aqu√≠ si quer√©s 320px, 280px, etc. */
      width: 100% !important;
      object-fit: contain !important;
      display: block !important;
      margin: 0 auto 10px !important;
      border-radius: 12px !important;
      border: 1px solid #ffe0b2 !important;
      background: #fff !important;
    }
    @media (max-width: 600px){
      #product-list .product img,
      .product img,
      img.product-image {
        height: 260px !important;   /* un poco menos alto en m√≥vil, si quer√©s */
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>CAPI</h1>
    <div id="slogan">100% —Ç–∞–±–∏–≥—ã–π –ø—Ä–æ–¥—É–∫—Ç—ã–ª–∞—Ä</div>
  </header>

  <main>
    <section id="product-list"></section>
  </main>

  <!-- Carrito -->
  <button id="cart-button">üõí<span id="cart-count">0</span></button>
  <div id="cart-popup" class="hidden">
    <h3 id="cart-title">–°–µ–±–µ—Ç</h3>
    <ul id="cart-items" style="list-style: none; padding-left: 0;"></ul>
    <div id="cart-total" style="font-weight: 700; margin-top: 8px;">TOTAL: 0 —Å–æ–º / $0.00</div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="confirm-btn">‚úÖ –ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ</button>
      <button id="close-cart">‚úï</button>
    </div>
  </div>

  <script>
    // === CONFIGURACI√ìN WHATSAPP + GOOGLE SHEETS ===
    const PHONE_KG = "996559500551";
    const PHONE_US = "17866514487";
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwh0COks2zW82RXr9_3li-XNuixON0yI5wMOoNps74HC4z6eitTW_NEgD7CYWmwN7nX/exec";

    // Si hubiera service worker viejo, lo quitamos para evitar cach√©
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
    }

    // === DATA ===
    const translations = {
      honey: { ky:"–ë–∞–ª", ru:"–ú—ë–¥", es:"Miel", en:"Honey" },
      mango_sauce: { ky:"–ê—á—ã—Ç—É—É –º–∞–Ω–≥–æ —Å–æ—É—Å—É", ru:"–û—Å—Ç—Ä—ã–π —Å–æ—É—Å –∏–∑ –º–∞–Ω–≥–æ", es:"Salsa Picante de Mango Verde", en:"Green Mango Hot Sauce" },
      price: { ky:"–ë–∞–∞—Å—ã:", ru:"–¶–µ–Ω–∞:", es:"Precio:", en:"Price:" },
      add_to_cart: { ky:"–°–µ–±–µ—Ç–∫–µ –∫–æ—à—É—É", ru:"–í –∫–æ—Ä–∑–∏–Ω—É", es:"Agregar al carrito", en:"Add to cart" },
      remove: { ky:"”®—á“Ø—Ä“Ø“Ø", ru:"–£–¥–∞–ª–∏—Ç—å", es:"Eliminar", en:"Remove" },
      your_cart: { ky:"–°–µ–±–µ—Ç–∏“£–∏–∑", ru:"–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞", es:"Tu carrito", en:"Your cart" },
      cart_empty: { ky:"–°–µ–±–µ—Ç–∏“£–∏–∑ –±–æ—à", ru:"–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è", es:"Tu carrito est√° vac√≠o", en:"Your cart is empty" },
      confirm_order: { ky:"–ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ", ru:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", es:"Confirmar pedido", en:"Confirm order" },
    };
    const currentLang = 'ky';

    const products = [
      { id:"honey", img:"honey_logo.png", img2x:"honey_logo@2x.png",
        name: translations.honey, sizes: { "230":{kgs:307,usd:3.5}, "500":{kgs:550,usd:6.3}, "1000":{kgs:874,usd:10.0} } },
      { id:"mango_sauce", img:"mango_logo.png", img2x:"mango_logo@2x.png",
        name: translations.mango_sauce, sizes: { "230":{kgs:307,usd:3.5}, "500":{kgs:699,usd:8.0}, "1000":{kgs:1750,usd:20.0} } }
    ];

    // === STATE ===
    let cart = [];
    let sending = false;

    // === RENDER ===
    function renderProducts() {
      const list = document.getElementById("product-list");
      list.innerHTML = "";
      products.forEach(product => {
        const div = document.createElement("div");
        div.className = "product";

        const name = product.name[currentLang];

        // Imagen (con srcset si tienes @2x)
        const img = document.createElement("img");
        img.className = "product-image";
        img.alt = name;
        img.src = product.img;
        if (product.img2x) img.srcset = `${product.img} 1x, ${product.img2x} 2x`;
        div.appendChild(img);

        const title = document.createElement("h2");
        title.textContent = name;
        div.appendChild(title);

        const selector = document.createElement("select");
        selector.className = "size-selector";
        for (let size in product.sizes) {
          const opt = document.createElement("option");
          opt.value = size; opt.textContent = `${size} ml`;
          selector.appendChild(opt);
        }
        div.appendChild(selector);

        const priceLabel = document.createElement("p");
        priceLabel.className = "price-label";
        const firstSize = Object.keys(product.sizes)[0];
        priceLabel.textContent = `${translations.price[currentLang]} ${product.sizes[firstSize].kgs} —Å–æ–º / $${product.sizes[firstSize].usd}`;
        div.appendChild(priceLabel);

        selector.onchange = () => {
          const size = selector.value;
          const price = product.sizes[size];
          priceLabel.textContent = `${translations.price[currentLang]} ${price.kgs} —Å–æ–º / $${price.usd}`;
        };

        const controls = document.createElement("div");
        controls.innerHTML = `
          <button class="decrease">‚àí</button>
          <span class="quantity">1</span>
          <button class="increase">+</button>
        `;
        div.appendChild(controls);

        controls.querySelector(".decrease").onclick = () => {
          let q = controls.querySelector(".quantity");
          let val = parseInt(q.textContent);
          if (val > 1) q.textContent = val - 1;
        };
        controls.querySelector(".increase").onclick = () => {
          let q = controls.querySelector(".quantity");
          q.textContent = parseInt(q.textContent) + 1;
        };

        const addBtn = document.createElement("button");
        addBtn.textContent = translations.add_to_cart[currentLang];
        addBtn.onclick = () => {
          const size = selector.value;
          const quantity = parseInt(controls.querySelector(".quantity").textContent);
          addToCart(product.id, name, size, quantity, product.sizes[size]);
        };
        div.appendChild(addBtn);

        list.appendChild(div);
      });
    }

    function addToCart(id, name, size, quantity, price) {
      const key = id + "-" + size;
      const index = cart.findIndex(item => item.key === key);
      if (index > -1) cart[index].quantity += quantity;
      else cart.push({ key, id, name, size, quantity, price });
      renderCart();
      updateCartCount();
    }

    function removeItem(index) {
      cart.splice(index, 1);
      renderCart();
      updateCartCount();
    }

    function renderCart() {
      const list = document.getElementById("cart-items");
      list.innerHTML = "";
      let totalKGS = 0, totalUSD = 0;

      cart.forEach((item, index) => {
        const li = document.createElement("li");
        li.textContent = `${item.name} ${item.size} ml x${item.quantity} (${item.price.kgs} —Å–æ–º / $${item.price.usd}) `;
        const btn = document.createElement("button");
        btn.textContent = translations.remove[currentLang];
        btn.onclick = () => removeItem(index);
        li.appendChild(btn);
        list.appendChild(li);

        totalKGS += item.quantity * item.price.kgs;
        totalUSD += item.quantity * item.price.usd;
      });

      document.getElementById("cart-total").innerHTML =
        `<strong>TOTAL: ${totalKGS} —Å–æ–º / $${totalUSD.toFixed(2)}</strong>`;
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      const badge = document.getElementById("cart-count");
      if (count > 0) {
        badge.style.display = "inline-block";
        badge.textContent = count;
      } else {
        badge.style.display = "none";
      }
    }

    function toggleCart() {
      document.getElementById("cart-popup").classList.toggle("hidden");
    }

    document.getElementById("cart-button").onclick = toggleCart;
    document.getElementById("close-cart").onclick = toggleCart;

    // === Confirmar pedido ‚Üí Sheets + WhatsApp ===
    function confirmOrder() {
      if (sending) return;
      if (cart.length === 0) {
        alert("üõí " + translations.cart_empty[currentLang]);
        return;
      }
      sending = true;

      // Mensaje y totales
      let message = "üßæ " + translations.your_cart[currentLang] + ":\n";
      let totalKGS = 0, totalUSD = 0;

      cart.forEach(item => {
        const subKGS = item.price.kgs * item.quantity;
        const subUSD = item.price.usd * item.quantity;
        message += `‚Ä¢ ${item.name} (${item.size} ml) x${item.quantity} = ${subKGS} —Å–æ–º / $${subUSD.toFixed(2)}\n`;
        totalKGS += subKGS;
        totalUSD += subUSD;
      });
      message += `\nTOTAL: ${totalKGS} —Å–æ–º / $${totalUSD.toFixed(2)}`;

      const orderId = "CAPI-" + Math.random().toString(16).slice(2,10).toUpperCase();
      message += `\n\nID: ${orderId}`;

      const orderPayload = {
        orderId,
        alive: true,
        version: "orders-v3-clean",
        to: `${PHONE_KG},${PHONE_US}`,
        totalUSD: Number(totalUSD.toFixed(2)),
        totalKGS: Number(totalKGS),
        currency: "USD/KGS",
        lang: currentLang,
        items: cart.map(i => ({
          id: i.id,
          name: i.name,
          ml: Number(i.size),
          qty: Number(i.quantity),
          usd: Number(i.price.usd),
          kgs: Number(i.price.kgs)
        })),
        created_at: new Date().toISOString()
      };

      // Enviar a Google Sheets (sin preflight)
      try {
        fetch(SHEETS_WEBAPP_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(orderPayload)   // sin headers
        });
      } catch(_) {}

      // WhatsApp a ambos n√∫meros
      const encodedMsg = encodeURIComponent(message);
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const urlKG = isMobile ? `whatsapp://send?phone=${PHONE_KG}&text=${encodedMsg}` : `https://wa.me/${PHONE_KG}?text=${encodedMsg}`;
      window.open(urlKG, "_blank");
      const urlUS = isMobile ? `whatsapp://send?phone=${PHONE_US}&text=${encodedMsg}` : `https://wa.me/${PHONE_US}?text=${encodedMsg}`;
      setTimeout(() => window.open(urlUS, "_blank"), 500);

      // Reset
      cart = [];
      renderCart();
      updateCartCount();
      document.getElementById("cart-popup").classList.add("hidden");
      sending = false;
    }
    document.getElementById("confirm-btn").onclick = confirmOrder;

    // === Init ===
    renderProducts();
  </script>
</body>
</html>

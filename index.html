<!DOCTYPE html>
<html lang="ky">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CAPIFAN ‚Äî —Ç–∞–±–∏—è—Ç—Ç–∞–Ω —Å–∏–∑–¥–∏–Ω –¥–∞—Å—Ç–æ—Ä–∫–æ–Ω—É“£—É–∑–≥–∞</title>
  <meta name="theme-color" content="#d86916"/>
  <link rel="manifest" href="manifest.json?v=2">

  <!-- iOS / iPadOS app icon -->
  <link rel="apple-touch-icon" sizes="120x120" href="icons/ios-120x120.png?v=2">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/ios-180x180.png?v=2">
  <link rel="apple-touch-icon" sizes="1024x1024" href="icons/ios-1024x1024.png?v=2">

  <!-- PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <!-- üé® Estilos generales -->
  <style>
    :root{--mango:#f3a21b;--honey:#d86916;--ink:#1e293b;--muted:#64748b;--card:#fff;--bg:#fff7ec}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,#fff,var(--bg))}
    .topbar{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:rgba(255,255,255,.88);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #ffe1ad}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:radial-gradient(100% 100% at 30% 30%, var(--mango), var(--honey));box-shadow:0 6px 20px rgba(216,105,22,.25)}
    .brand-name{font-weight:800} .slogan{font-size:12px;color:var(--muted)}
    .controls{display:flex;align-items:center;gap:8px}
    select,.btn{border:1px solid #ffd489;background:#fff;color:var(--ink);padding:8px 10px;border-radius:12px;font:inherit}
    .btn.mango{background:linear-gradient(180deg,#fff8eb,#ffe3b3);font-weight:700;cursor:pointer}
    .shell{max-width:1100px;margin:0 auto;padding:16px}
    .notice{margin:10px 16px;padding:10px 12px;border:1px dashed #ffd08a;border-radius:12px;background:#fff7e8;color:#6a3c13;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #ffe1ad;border-radius:18px;padding:14px;box-shadow:0 6px 16px rgba(243,162,27,.08);display:flex;flex-direction:column;gap:10px}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:12px;border:1px solid #ffe1ad}
    .qty{display:flex;align-items:center;gap:8px}.qty .q{min-width:22px;text-align:center;display:inline-block}

    /* ===== Carrito (popup en m√≥viles) ===== */
    .popup{position:fixed; inset:0; z-index:1000; display:block; pointer-events:none;}
    .popup.open{ pointer-events:auto; }
    .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.35); opacity:0; transition:opacity .2s ease;}
    .popup.open .backdrop{ opacity:1; }
    .panel{position:fixed; left:0; right:0; bottom:0; top: calc(env(safe-area-inset-top, 0px) + 64px); background:#fff; border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:0 -10px 30px rgba(0,0,0,.15); transform: translateY(100%); transition: transform .25s ease; display:flex; flex-direction:column; padding:calc(12px + env(safe-area-inset-top, 0px)) 16px calc(14px + env(safe-area-inset-bottom, 0px)); overflow:hidden;}
    .popup.open .panel{ transform: translateY(0); }
    .panel #cartItems{ flex:1; overflow:auto; -webkit-overflow-scrolling:touch; }
    body.no-scroll{ overflow:hidden; height:100dvh; }
    .badge{background:#dc2626;color:#fff;border-radius:999px;min-width:18px;padding:2px 6px;font-size:12px}
    .foot{color:var(--muted);text-align:center;padding:16px}

    /* Bot√≥n eliminar */
    .btn-remove{background:linear-gradient(180deg,rgba(255,0,0,0.12),rgba(255,0,0,0.18));border:1px solid rgba(255,0,0,0.25);color:#000;font-weight:600;cursor:pointer;transition:transform 0.05s ease,background 0.2s ease;border-radius:12px;padding:8px 10px;}
    .btn-remove:hover{background:linear-gradient(180deg,rgba(255,0,0,0.18),rgba(255,0,0,0.25));}
    .btn-remove:active{transform:scale(0.97);}
     
    /* Bot√≥n cerrar carrito */
    #closeCart{background:linear-gradient(180deg,#d1f7d1,#a6e3a6);border:1px solid #6ccf6c;color:#000;font-weight:700;cursor:pointer;border-radius:12px;padding:8px 10px;}
    #closeCart:hover{background:linear-gradient(180deg,#a6e3a6,#8cd88c);}
  </style>

  <!-- üñºÔ∏è OVERRIDE im√°genes -->
  <style id="imgfix-override">
    #product-list .product img,
    .product img,
    img.product-image {
      height: 320px !important;
      width: 100% !important;
      object-fit: contain !important;
      display: block !important;
      margin: 0 auto 10px !important;
      border-radius: 12px !important;
      border: 1px solid #ffe1ad !important;
    }
  </style>

  <!-- ‚úÖ Bot√≥n Confirmar Pedido -->
  <style id="confirm-btn-final">
    aside #confirm {
      -webkit-appearance: none;
      appearance: none;
      width: auto;
      padding: 10px 14px;
      font-size: 1em;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    aside #confirm:disabled {
      background: #f0f0f0 !important;
      color: #000 !important;
      border: 1px solid #ccc !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
    }
    aside #confirm:not(:disabled) {
      background: linear-gradient(180deg, #fcd34d, #f59e0b) !important;
      color: #000 !important;
      border: 1px solid #d97706 !important;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.4),
                  0 4px 10px rgba(0, 0, 0, 0.15) !important;
    }
    aside #confirm:not(:disabled):hover {
      background: linear-gradient(180deg, #fde68a, #f59e0b) !important;
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.6),
                  0 6px 14px rgba(0, 0, 0, 0.2) !important;
      transform: scale(1.02);
    }
    aside #confirm:not(:disabled):active {
      transform: scale(0.98);
      box-shadow: 0 0 6px rgba(245, 158, 11, 0.3),
                  0 3px 6px rgba(0, 0, 0, 0.2) !important;
    }
    @media (max-width: 600px){
      aside #confirm {
        width: auto !important;
        flex: 0 0 auto !important;
        display: inline-flex !important;
        align-self: flex-start;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"/>
<style>
  /* Peque√±os ajustes */
  .iti { width: 100%; }               /* el input ocupa todo el ancho */
  .iti__country-list { z-index: 1100; } /* men√∫ por encima del popup del carrito */
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="brand-name">CAPIFAN</div>
        <div class="slogan" id="slogan">—Ç–∞–±–∏—è—Ç—Ç–∞–Ω —Å–∏–∑–¥–∏–Ω –¥–∞—Å—Ç–æ—Ä–∫–æ–Ω—É“£—É–∑–≥–∞</div>
      </div>
    </div>
    <div class="controls">
      <label for="lang">üåê</label>
      <select id="lang" aria-label="Language">
        <option value="ky" selected>üá∞üá¨ –öY</option>
        <option value="ru">üá∑üá∫ RU</option>
        <option value="es">üá™üá∏ ES</option>
        <option value="en">üá¨üáß EN</option>
      </select>
      <button id="btnCart" class="btn mango">üõí <span id="cartTxt">–°–µ–±–µ—Ç</span> <span id="cartCount" class="badge" style="display:none">0</span></button>
    </div>
  </header>

  <main class="shell">
    <div class="notice" id="pricesNote">–ë–∞–∞–ª–∞—Ä USD –∂–∞–Ω–∞ KGS –º–µ–Ω–µ–Ω. ”®–ª—á”©–º–¥“Ø ”©–∑–≥”©—Ä—Ç“Ø–ø –±–∞–∞–Ω—ã –∫”©—Ä“Ø“£“Ø–∑.</div>
    <section id="products" class="grid"></section>
  </main>

  <!-- Cart -->
  <aside id="cart" class="popup" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <div class="backdrop" id="backdrop"></div>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="cartTitle">–°–µ–±–µ—Ç</h2>
        <button class="btn" id="closeCart" aria-label="Cerrar">‚úï</button>
      </div>
      <div id="cartItems"></div>
      <div id="totals" style="margin-top:8px;font-weight:800">TOTAL: 0 —Å–æ–º / $0.00</div>

<!-- Aviso fijo (siempre visible, se traduce con i18n) -->
<small id="formNotice" style="color:#d97706;font-weight:600;display:block;">
üëáüèº Por favor, complete todos los campos obligatorios üëáüèº
</small>

<!-- Error din√°mico (se muestra solo si el tel√©fono es inv√°lido) -->
<small id="formError" style="color:red;font-weight:600;display:none;"></small>

<!-- Campos obligatorios -->
<div id="customerInfo" style="margin-top:12px; display:flex; flex-direction:column; gap:8px">
  <input type="text" id="custName" placeholder="Tu nombre" required style="padding:8px;border:1px solid #ccc;border-radius:8px;">
  <input type="tel" id="custPhone" placeholder="Tu tel√©fono" required style="padding:8px;border:1px solid #ccc;border-radius:8px;">
  <input type="email" id="custEmail" placeholder="Tu email" required style="padding:8px;border:1px solid #ccc;border-radius:8px;">
</div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
  <button id="confirm" class="btn-capipro" disabled>
  ‚úÖ –ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ
</button>
</div>
  </aside>

  <footer class="foot">¬© 2025 CAPIFAN ‚Äì elcapiproduct@gmail.com</footer>

<script>
/* ================== CONFIG ================== */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxab8-ziPP2u5oAhQJKBzxzhrc54-Qz_s4xAzbLg_on1Wl5Z9zthTNPxwVSWUylBCoz/exec";
const PHONE_KG = "996559500551";
const PHONE_US = "17866514487";
const EXCHANGE_KGS_PER_USD = 89;

/* Idioma por defecto: KY (respeta localStorage si ya existe) */
let lang = localStorage.getItem("capi_lang") || "ky";

/* ================== DATA ================== */
const PRODUCTS = [
  { 
    id:"honey", 
    img:"honey_logo.png", 
    name:{
      ky:"–¢–∞–∑–∞ –±–∞–ª Issyk Kul", 
      ru:"–ß–∏—Å—Ç—ã–π –º—ë–¥ Issyk Kul", 
      es:"Miel Pura Issyk Kul", 
      en:"Pure Honey Issyk Kul"
    }, 
    sizes:[
      {ml:350,usd:4.0},
      {ml:500,usd:6.3},
      {ml:1000,usd:10.0}
    ] 
  },
  { 
    id:"mango", 
    img:"mango_logo.png", 
    name:{
      ky:"–ñ–∞—à—ã–ª –º–∞–Ω–≥–æ –∞—á—É—É —Å–æ—É—Å—É",
      ru:"–û—Å—Ç—Ä—ã–π —Å–æ—É—Å –∏–∑ –∑–µ–ª—ë–Ω–æ–≥–æ –º–∞–Ω–≥–æ",
      es:"Salsa Picante de Mango Verde",
      en:"Green Mango Hot Sauce"
    }, 
    sizes:[
      {ml:350,usd:4.0},
      {ml:500,usd:9.0},
      {ml:1000,usd:20.0}
    ] 
  },
  { 
    id:"pepper_red", 
    img:"redpepper_logo.png", 
    name:{
      ky:"–ö—ã–∑—ã–ª –∫–∞–ª–µ–º–ø–∏—Ä —Å–æ—É—Å—É",
      ru:"–°–æ—É—Å –∏–∑ –∫—Ä–∞—Å–Ω–æ–≥–æ –ø–µ—Ä—Ü–∞",
      es:"Salsa Pimiento Rojo",
      en:"Red Pepper Sauce"
    }, 
    sizes:[
      {ml:350,usd:3.5},
      {ml:500,usd:8.0},
      {ml:1000,usd:20.0}
    ] 
  },
  { 
    id:"pepper_green", 
    img:"greenpepper_logo.png", 
    name:{
      ky:"–ñ–∞—à—ã–ª –∫–∞–ª–µ–º–ø–∏—Ä —Å–æ—É—Å—É",
      ru:"–°–æ—É—Å –∏–∑ –∑–µ–ª—ë–Ω–æ–≥–æ –ø–µ—Ä—Ü–∞",
      es:"Salsa Pimiento Verde",
      en:"Green Pepper Sauce"
    }, 
    sizes:[
      {ml:350,usd:3.5},
      {ml:500,usd:8.0},
      {ml:1000,usd:20.0}
    ] 
  }
];


const T = {
  title:{ ky:"–ü—Ä–æ–¥—É–∫—Ü–∏—è–ª–∞—Ä 100% —Ç–∞–±–∏–≥—ã–π", ru:"–ü—Ä–æ–¥—É–∫—Ü–∏—è 100% –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è", es:"Productos 100% Natural", en:"100% Natural Products" },
  prices_note:{ ky:"–ë–∞–∞–ª–∞—Ä USD –∂–∞–Ω–∞ KGS –º–µ–Ω–µ–Ω. ”®–ª—á”©–º–¥“Ø ”©–∑–≥”©—Ä—Ç“Ø–ø –±–∞–∞–Ω—ã –∫”©—Ä“Ø“£“Ø–∑.", ru:"–¶–µ–Ω—ã –≤ USD –∏ —Å–æ–º–∞—Ö. –ú–µ–Ω—è–π—Ç–µ –æ–±—ä—ë–º, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ü–µ–Ω—É.", es:"Precios en USD y KGS. Cambia el tama√±o para ver el precio.", en:"Prices in USD and KGS. Change size to see price." },
  cart:{ ky:"–°–µ–±–µ—Ç", ru:"–ö–æ—Ä–∑–∏–Ω–∞", es:"Tu carrito", en:"Your cart" },
  add:{ ky:"–°–µ–±–µ—Ç–∫–µ –∫–æ—à—É—É", ru:"–í –∫–æ—Ä–∑–∏–Ω—É", es:"Agregar al carrito", en:"Add to cart" },
  remove:{ ky:"”®—á“Ø—Ä“Ø“Ø", ru:"–£–¥–∞–ª–∏—Ç—å", es:"Eliminar", en:"Remove" },
  empty_cart:{ ky:"–°–µ–±–µ—Ç –±–æ—à", ru:"–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞", es:"El carrito est√° vac√≠o", en:"Cart is empty" },
  confirm:{ ky:"–ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ", ru:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", es:"Confirmar pedido", en:"Confirm order" },
  price_lbl:{ ky:"–ë–∞–∞—Å—ã:", ru:"–¶–µ–Ω–∞:", es:"Precio:", en:"Price:" },
  fill_required:{ 
    ky:"–ë–∞—Ä–¥—ã–∫ —Ç–∞–ª–∞–∞–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑.", 
    ru:"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.", 
    es:"Por favor, complete todos los campos obligatorios.", 
    en:"Please fill in all required fields." 
  },
  name_ph:{ ky:"–ê—Ç—ã“£—ã–∑", ru:"–í–∞—à–µ –∏–º—è", es:"Tu nombre", en:"Your name" },
  phone_ph:{ ky:"–¢–µ–ª–µ—Ñ–æ–Ω—É“£—É–∑", ru:"–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω", es:"Tu tel√©fono", en:"Your phone" },
  email_ph:{ ky:"–≠–ª–µ–∫—Ç—Ä–æ–Ω –ø–æ—á—Ç–∞", ru:"–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞", es:"Tu email", en:"Your email" }
};
/* ================== HELPERS ================== */
function kgs(usd){ return Math.round(usd*EXCHANGE_KGS_PER_USD); }
function money(n){ return (Math.round(n*100)/100).toFixed(2); }
function genOrderId(){ return "CAPI-" + Math.random().toString(16).slice(2,10).toUpperCase(); }
function sendToSheets(order){
  try{
    if (navigator.sendBeacon) {
      const blob = new Blob([JSON.stringify(order)], { type: "text/plain;charset=utf-8" });
      navigator.sendBeacon(SHEETS_WEBAPP_URL, blob);
      return;
    }
  }catch(_){}
  try{
    fetch(SHEETS_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(order)
    });
  }catch(_){}
}

/* ================== STATE ================== */
let cart = [];
let iti = null; // üìû instancia global para intl-tel-input

/* ================== UI ================== */
function i18n(){
  document.getElementById("slogan").textContent = T.title[lang];
  document.getElementById("pricesNote").textContent = T.prices_note[lang];
  document.getElementById("cartTxt").textContent = T.cart[lang];
  document.getElementById("cartTitle").textContent = T.cart[lang];
  document.getElementById("confirm").textContent = "‚úÖ " + T.confirm[lang];

  // === NUEVO: actualizar placeholders ===
  document.getElementById("custName").placeholder  = T.name_ph[lang];
  document.getElementById("custPhone").placeholder = T.phone_ph[lang];
  document.getElementById("custEmail").placeholder = T.email_ph[lang];

  // üü¢ actualizar mensaje fijo de error
  const err = document.getElementById("formError");
  if (err) {
    err.textContent = "üêù " + T.fill_required[lang];
  }
}
function renderProducts(){
  const root = document.getElementById("products");
  root.innerHTML = "";
  PRODUCTS.forEach(p=>{
    const card = document.createElement("div"); card.className="card";
    if (p.img) {
      const img = document.createElement("img");
      img.src = p.img; img.alt = p.name[lang];
      img.onerror = ()=>{ img.remove(); };
      img.className = "product-image";
      card.appendChild(img);
    }
    const h3 = document.createElement("h3"); h3.textContent = p.name[lang]; card.appendChild(h3);
    const sel = document.createElement("select");
    p.sizes.forEach((s,i)=>{ const o=document.createElement("option"); o.value=s.ml; o.textContent=`${s.ml} ml`; sel.appendChild(o); if(i===0) sel.value=s.ml; });
    card.appendChild(sel);
    const price = document.createElement("div");
    const s0 = p.sizes[0]; price.innerHTML = `${T.price_lbl[lang]} ${kgs(s0.usd)} —Å–æ–º / $${money(s0.usd)}`;
    card.appendChild(price);
    sel.onchange = ()=> {
      const s = p.sizes.find(x=>x.ml==sel.value);
      price.innerHTML = `${T.price_lbl[lang]} ${kgs(s.usd)} —Å–æ–º / $${money(s.usd)}`;
    };
    const controls = document.createElement("div"); controls.className="qty";
    const dec = document.createElement("button"); dec.textContent="‚àí";
    const q = document.createElement("span"); q.className="q"; q.textContent="1";
    const inc = document.createElement("button"); inc.textContent="+";
    dec.onclick = ()=>{ q.textContent = Math.max(1, parseInt(q.textContent)-1); };
    inc.onclick = ()=>{ q.textContent = parseInt(q.textContent)+1; };
    controls.append(dec,q,inc); card.appendChild(controls);
    const add = document.createElement("button"); add.className="btn mango"; add.textContent = T.add[lang];
    add.onclick = ()=>{
      const size = parseInt(sel.value,10);
      const unit = p.sizes.find(x=>x.ml===size).usd;
      addToCart(p.id, p.name[lang], size, parseInt(q.textContent,10), {usd:unit,kgs:kgs(unit)});
    };
    card.appendChild(add);
    root.appendChild(card);
  });
}

function addToCart(id, name, size, qty, price){
  const key = id + "-" + size + "-" + Date.now() + "-" + Math.random().toString(16).slice(2,6);
  cart.push({ key, id, name, size, qty, price });
  updateCart();
}

function updateCart(){
  const items = document.getElementById("cartItems");
  const count = document.getElementById("cartCount");
  items.innerHTML = "";
  let totUSD=0, totKGS=0;

  cart.forEach((it,idx)=>{
    const row = document.createElement("div");
    row.className = "row";

     const icon = it.id === "honey" ? "üçØ" 
            : it.id === "mango" ? "ü•≠üå∂Ô∏è" 
            : it.id === "pepper_red" ? "üçÖ"     // tomate para red pepper
            : it.id === "pepper_green" ? "ü´ë"   // pimiento verde
            : "‚Ä¢";

    row.innerHTML = `<span>${icon} ${it.name} ${it.size} ml x${it.qty} (${it.price.kgs} —Å–æ–º / $${money(it.price.usd)})</span>`;

    const rm = document.createElement("button");
    rm.className = "btn-remove";
    rm.textContent = "üóë";
    rm.onclick = ()=>{ cart.splice(idx,1); updateCart(); };

    row.appendChild(rm);
    items.appendChild(row);

    totUSD += it.price.usd * it.qty;
    totKGS += it.price.kgs * it.qty;
  });

  document.getElementById("totals").textContent = `TOTAL: ${totKGS} —Å–æ–º / $${money(totUSD)}`;

  if(cart.length > 0){
    count.style.display = "inline-block";
    count.textContent = cart.reduce((a,c)=>a+c.qty,0);
  } else {
    count.style.display = "none";
  }
}

function openCart(){
  document.getElementById("cart").classList.add("open");
  document.body.classList.add("no-scroll");
}
function closeCart(){
  document.getElementById("cart").classList.remove("open");
  document.body.classList.remove("no-scroll");
}
function toggleCart(){
  const el = document.getElementById("cart");
  const willOpen = !el.classList.contains("open");
  el.classList.toggle("open");
  document.body.classList.toggle("no-scroll", willOpen);
}

function confirmOrder(){
  if(cart.length===0){ 
    alert(T.empty_cart[lang] + " ‚Äî TOTAL: $0 / 0 —Å–æ–º"); 
    return; 
  }

  const name  = document.getElementById("custName").value.trim();
  const email = document.getElementById("custEmail").value.trim();
  const err   = document.getElementById("formError");

  // ‚úÖ n√∫mero desde intl-tel-input
  let phone = "";
  if (iti && iti.isValidNumber()) {
    phone = iti.getNumber(); // siempre en formato internacional
  } else {
    if (err) {
      err.textContent = "üêù " + T.fill_required[lang];
      err.style.display = "block";
    }
    return;
  }

  if (!name || !email) {
    if (err) {
      err.textContent = "üêù " + T.fill_required[lang];
      err.style.display = "block";
    }
    return;
  } else {
    if (err) err.style.display = "none";
  }

  // üìù Mensaje WhatsApp
  let msg = "üßæ " + T.cart[lang] + ":\n";
  let totUSD=0, totKGS=0;
  cart.forEach(it=>{ 
    const subU=it.price.usd*it.qty, subK=it.price.kgs*it.qty;
    msg += `‚Ä¢ ${it.name} (${it.size} ml) x${it.qty} = ${subK} —Å–æ–º / $${money(subU)}\n`;
    totUSD += subU; totKGS += subK; 
  });
  msg += `\nTOTAL: ${totKGS} —Å–æ–º / $${money(totUSD)}`;
  const orderId = genOrderId(); 
  msg += `\n\nID: ${orderId}`;

  // üì¶ Payload para Google Sheets
  const payload = { 
    orderId, 
    alive:true, 
    version:"orders-v4-clean+invoices", 
    to: PHONE_KG + "," + PHONE_US,
    totalUSD:Number(money(totUSD)), 
    totalKGS:Number(totKGS), 
    currency:"USD/KGS", 
    lang,
    items: cart.map(it=>({
      id:it.id,
      name:it.name,
      ml:Number(it.size),
      qty:Number(it.qty),
      usd:Number(it.price.usd),
      kgs:Number(it.price.kgs)
    })),
    created_at:new Date().toISOString(),
    customer:name,
    phone:phone,   // ‚úÖ ahora va el n√∫mero internacional validado
    email:email,
    autoInvoice:true
  };

  sendToSheets(payload);

  // üì≤ Enviar a WhatsApp
  const enc = encodeURIComponent(msg);
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const urlKG = isMobile 
    ? `whatsapp://send?phone=${PHONE_KG}&text=${enc}` 
    : `https://wa.me/${PHONE_KG}?text=${enc}`; 
  window.open(urlKG,"_blank");

  const urlUS = isMobile 
    ? `whatsapp://send?phone=${PHONE_US}&text=${enc}` 
    : `https://wa.me/${PHONE_US}?text=${enc}`; 
  setTimeout(()=>window.open(urlUS,"_blank"),500);

  // üßπ Reset del carrito
  cart = []; 
  updateCart(); 
  closeCart();
}
</script>

<script>
/* ================== INIT ================== */
if ('serviceWorker' in navigator) { 
  navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())); 
}

window.addEventListener("load", () => {
  try{
    // === Idiomas y UI b√°sica ===
    const sel = document.getElementById("lang");
    sel.value = lang;
    sel.onchange = (e)=>{ 
      lang=e.target.value; 
      localStorage.setItem("capi_lang",lang); 
      i18n(); renderProducts(); updateCart(); 
    };
    document.getElementById("btnCart").onclick = openCart;
    document.getElementById("closeCart").onclick = closeCart;
    document.getElementById("backdrop").onclick = closeCart;
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeCart(); });
    document.getElementById("confirm").onclick = confirmOrder;
    i18n(); renderProducts(); updateCart();
    fetch(SHEETS_WEBAPP_URL).catch(()=>{});

    // === intl-tel-input inicializaci√≥n ===
const phoneInput = document.querySelector("#custPhone");
if (phoneInput) {
  iti = window.intlTelInput(phoneInput, {
    initialCountry: "kg",
    preferredCountries: ["kg","us","es","kz","ru"],
    dropdownContainer: document.body,
    separateDialCode: true,
    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
  });

  // üöÄ Arranca en rojo
  phoneInput.classList.add("input-error");

  // üö´ Bloquear letras y limitar a 15 d√≠gitos + validar recuadro
  phoneInput.addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/[^0-9+]/g, "");
    const raw = e.target.value.replace(/\D/g, "");
    if (raw.length > 15) {
      e.target.value = "+" + raw.slice(0, 15);
    }

    // üîÑ Recuadro rojo ON/OFF
    if (phoneInput.value.trim() && iti.isValidNumber()) {
      phoneInput.classList.remove("input-error"); // ‚úÖ se apaga
    } else {
      phoneInput.classList.add("input-error");    // üî¥ sigue rojo
    }
  });
}

    // === Validaci√≥n de campos obligatorios ===
    const inputs = ["custName","custPhone","custEmail"].map(id => document.getElementById(id));
    const phoneEl = document.getElementById("custPhone");

    function validateForm(){
      const name  = document.getElementById("custName").value.trim();
      const email = document.getElementById("custEmail").value.trim();
      let phoneValid = (iti && iti.isValidNumber());
      const filled = (name !== "" && email !== "" && phoneValid);
      document.getElementById("confirm").disabled = !filled;
    }

    // ‚úÖ Valida el tel√©fono en vivo (solo resalta rojo si es inv√°lido)
function checkPhoneValidity(){
  if (!phoneEl) return;

  if (iti && iti.isValidNumber()) {
    // üî¢ Limitar a un m√°ximo de 15 d√≠gitos reales
    const raw = iti.getNumber().replace(/\D/g, "");
    if (raw.length > 15) {
      phoneEl.classList.add("input-error");
      return;
    }
    phoneEl.classList.remove("input-error");
  } else {
    phoneEl.classList.add("input-error");
  }
}

// Eventos en nombre/email/tel√©fono
inputs.forEach(i => i.addEventListener("input", validateForm));
if (phoneEl) {
  phoneEl.addEventListener("input", () => { checkPhoneValidity(); validateForm(); });
  phoneEl.addEventListener("countrychange", () => { checkPhoneValidity(); validateForm(); });
}
    
  } catch(e) {
    console.error("Init error:", e);
    document.getElementById("products").innerHTML = 
      "<div class='card'>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É / Vuelva a cargar la p√°gina.</div>";
  }
});
</script>

<!-- Librer√≠a intl-tel-input -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"></script>
</body>
</html>

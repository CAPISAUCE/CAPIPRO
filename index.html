<!DOCTYPE html>
<html lang="ky">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CAPI ‚Äî Productos 100% Natural</title>
  <meta name="theme-color" content="#d86916"/>
  <style>
    :root{--mango:#f3a21b;--honey:#d86916;--ink:#1e293b;--muted:#64748b;--card:#fff;--bg:#fff7ec}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,#fff,var(--bg))}
    .topbar{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:rgba(255,255,255,.88);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #ffe1ad}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:radial-gradient(100% 100% at 30% 30%, var(--mango), var(--honey));box-shadow:0 6px 20px rgba(216,105,22,.25)}
    .brand-name{font-weight:800} .slogan{font-size:12px;color:var(--muted)}
    .controls{display:flex;align-items:center;gap:8px}
    select,.btn{border:1px solid #ffd489;background:#fff;color:var(--ink);padding:8px 10px;border-radius:12px;font:inherit}
    .btn.mango{background:linear-gradient(180deg,#fff8eb,#ffe3b3);font-weight:700;cursor:pointer}
    .shell{max-width:1100px;margin:0 auto;padding:16px}
    .notice{margin:10px 16px;padding:10px 12px;border:1px dashed #ffd08a;border-radius:12px;background:#fff7e8;color:#6a3c13;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #ffe1ad;border-radius:18px;padding:14px;box-shadow:0 6px 16px rgba(243,162,27,.08);display:flex;flex-direction:column;gap:10px}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:12px;border:1px solid #ffe1ad}
    .qty{display:flex;align-items:center;gap:8px}.qty .q{min-width:22px;text-align:center;display:inline-block}
    .popup{position:fixed;inset:0;display:none}
    .popup.open{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .panel{position:absolute;right:0;top:0;bottom:0;width:min(480px,92%);background:#fff;border-left:1px solid #ffe1ad;box-shadow:-6px 0 20px rgba(0,0,0,.12);display:flex;flex-direction:column;padding:12px}
    .panel h2{margin:10px 0}
    .row{display:flex;justify-content:space-between;align-items:center;border:1px solid #ffe1ad;border-radius:12px;padding:8px;margin:6px 0}
    .badge{background:#dc2626;color:#fff;border-radius:999px;min-width:18px;padding:2px 6px;font-size:12px}
    .foot{color:var(--muted);text-align:center;padding:16px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="brand-name">CAPI</div>
        <div class="slogan" id="slogan">100% —Ç–∞–±–∏–≥—ã–π –ø—Ä–æ–¥—É–∫—Ç—ã–ª–∞—Ä</div>
      </div>
    </div>
    <div class="controls">
      <label for="lang">üåê</label>
      <select id="lang" aria-label="Language">
        <option value="ky" selected>üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞</option>
        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
        <option value="es">üá™üá∏ Espa√±ol</option>
        <option value="en">üá¨üáß English</option>
      </select>
      <button id="btnCart" class="btn mango">üõí <span id="cartTxt">–°–µ–±–µ—Ç</span> <span id="cartCount" class="badge" style="display:none">0</span></button>
    </div>
  </header>

  <main class="shell">
    <div class="notice" id="pricesNote">–ë–∞–∞–ª–∞—Ä USD –∂–∞–Ω–∞ KGS –º–µ–Ω–µ–Ω. ”®–ª—á”©–º–¥“Ø ”©–∑–≥”©—Ä—Ç“Ø–ø –±–∞–∞–Ω—ã –∫”©—Ä“Ø“£“Ø–∑.</div>
    <section id="products" class="grid"></section>
  </main>

  <!-- Cart -->
  <aside id="cart" class="popup" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <div class="backdrop" id="backdrop"></div>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="cartTitle">–°–µ–±–µ—Ç</h2>
        <button class="btn" id="closeCart" aria-label="Cerrar">‚úï</button>
      </div>
      <div id="cartItems"></div>
      <div id="totals" style="margin-top:8px;font-weight:800">TOTAL: 0 —Å–æ–º / $0.00</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="confirm" class="btn mango">‚úÖ –ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ</button>
      </div>
      <small id="postNote" style="color:#64748b"></small>
    </div>
  </aside>

  <footer class="foot">¬© CAPI</footer>

<script>
/* ================== CONFIG ================== */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwh0COks2zW82RXr9_3li-XNuixON0yI5wMOoNps74HC4z6eitTW_NEgD7CYWmwN7nX/exec";
const PHONE_KG = "996559500551";
const PHONE_US = "17866514487";
const EXCHANGE_KGS_PER_USD = 89;

/* Idioma por defecto: KY (respeta localStorage si ya existe) */
let lang = localStorage.getItem("capi_lang") || "ky";

/* ================== DATA ================== */
// RUTAS DE TUS IM√ÅGENES (aj√∫stalas a tus nombres reales en el repo)
const PRODUCTS = [
  {
    id:"honey",
    img:"images/miel.png", // <-- cambia si tu archivo se llama distinto
    name:{ky:"–ë–∞–ª",ru:"–ú—ë–¥",es:"Miel",en:"Honey"},
    sizes:[{ml:230,usd:3.0},{ml:500,usd:5.0},{ml:1000,usd:10.0}]
  },
  {
    id:"mango",
    img:"images/salsa-mango.png", // <-- cambia si tu archivo se llama distinto
    name:{ky:"–ñ–∞—à –º–∞–Ω–≥–æ –∞—á—É—É —Å–æ—É—Å—É",ru:"–û—Å—Ç—Ä—ã–π —Å–æ—É—Å –∏–∑ –∑–µ–ª—ë–Ω–æ–≥–æ –º–∞–Ω–≥–æ",es:"Salsa Picante de Mango Verde",en:"Green Mango Hot Sauce"},
    sizes:[{ml:230,usd:3.5},{ml:500,usd:8.0},{ml:1000,usd:20.0}]
  }
];

const T = {
  title:       { ky:"–ü—Ä–æ–¥—É–∫—Ü–∏—è–ª–∞—Ä 100% —Ç–∞–±–∏–≥—ã–π", ru:"–ü—Ä–æ–¥—É–∫—Ü–∏—è 100% –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è", es:"Productos 100% Natural", en:"100% Natural Products" },
  prices_note: { ky:"–ë–∞–∞–ª–∞—Ä USD –∂–∞–Ω–∞ KGS –º–µ–Ω–µ–Ω. ”®–ª—á”©–º–¥“Ø ”©–∑–≥”©—Ä—Ç“Ø–ø –±–∞–∞–Ω—ã –∫”©—Ä“Ø“£“Ø–∑.", ru:"–¶–µ–Ω—ã –≤ USD –∏ —Å–æ–º–∞—Ö. –ú–µ–Ω—è–π—Ç–µ –æ–±—ä—ë–º, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ü–µ–Ω—É.", es:"Precios en USD y KGS. Cambia el tama√±o para ver el precio.", en:"Prices in USD and KGS. Change size to see price." },
  cart:        { ky:"–°–µ–±–µ—Ç", ru:"–ö–æ—Ä–∑–∏–Ω–∞", es:"Tu carrito", en:"Your cart" },
  add:         { ky:"–°–µ–±–µ—Ç–∫–µ –∫–æ—à—É—É", ru:"–í –∫–æ—Ä–∑–∏–Ω—É", es:"Agregar al carrito", en:"Add to cart" },
  remove:      { ky:"”®—á“Ø—Ä“Ø“Ø", ru:"–£–¥–∞–ª–∏—Ç—å", es:"Eliminar", en:"Remove" },
  empty_cart:  { ky:"–°–µ–±–µ—Ç –±–æ—à", ru:"–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞", es:"El carrito est√° vac√≠o", en:"Cart is empty" },
  confirm:     { ky:"–ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ", ru:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", es:"Confirmar pedido", en:"Confirm order" },
  price_lbl:   { ky:"–ë–∞–∞—Å—ã:", ru:"–¶–µ–Ω–∞:", es:"Precio:", en:"Price:" }
};

/* ================== HELPERS ================== */
function kgs(usd){ return Math.round(usd*EXCHANGE_KGS_PER_USD); }
function money(n){ return (Math.round(n*100)/100).toFixed(2); }
function genOrderId(){ return "CAPI-" + Math.random().toString(16).slice(2,10).toUpperCase(); }
function sendToSheets(order){
  try{
    fetch(SHEETS_WEBAPP_URL, { method:"POST", mode:"no-cors", body: JSON.stringify(order) });
  }catch(_){}
}

/* ================== STATE ================== */
let cart = [];

/* ================== UI ================== */
function i18n(){
  document.getElementById("slogan").textContent = T.title[lang];
  document.getElementById("pricesNote").textContent = T.prices_note[lang];
  document.getElementById("cartTxt").textContent = T.cart[lang];
  document.getElementById("cartTitle").textContent = T.cart[lang];
  document.getElementById("confirm").textContent = "‚úÖ " + T.confirm[lang];
}

function renderProducts(){
  const root = document.getElementById("products");
  root.innerHTML = "";
  PRODUCTS.forEach(p=>{
    const card = document.createElement("div"); card.className="card";

    // Imagen con fallback (si no existe archivo, se oculta)
    if (p.img) {
      const img = document.createElement("img");
      img.src = p.img; img.alt = p.name[lang];
      img.onerror = ()=>{ img.remove(); };
      card.appendChild(img);
    }

    const h3 = document.createElement("h3"); h3.textContent = p.name[lang]; card.appendChild(h3);

    const sel = document.createElement("select");
    p.sizes.forEach((s,i)=>{ const o=document.createElement("option"); o.value=s.ml; o.textContent=`${s.ml} ml`; sel.appendChild(o); if(i===0) sel.value=s.ml; });
    card.appendChild(sel);

    const price = document.createElement("div");
    const s0 = p.sizes[0]; price.innerHTML = `${T.price_lbl[lang]} ${kgs(s0.usd)} —Å–æ–º / $${money(s0.usd)}`;
    card.appendChild(price);

    sel.onchange = ()=> {
      const s = p.sizes.find(x=>x.ml==sel.value);
      price.innerHTML = `${T.price_lbl[lang]} ${kgs(s.usd)} —Å–æ–º / $${money(s.usd)}`;
    };

    const controls = document.createElement("div"); controls.className="qty";
    const dec = document.createElement("button"); dec.textContent="‚àí";
    const q = document.createElement("span"); q.className="q"; q.textContent="1";
    const inc = document.createElement("button"); inc.textContent="+";
    dec.onclick = ()=>{ q.textContent = Math.max(1, parseInt(q.textContent)-1); };
    inc.onclick = ()=>{ q.textContent = parseInt(q.textContent)+1; };
    controls.append(dec,q,inc); card.appendChild(controls);

    const add = document.createElement("button"); add.className="btn mango"; add.textContent = T.add[lang];
    add.onclick = ()=>{
      const size = parseInt(sel.value,10);
      const unit = p.sizes.find(x=>x.ml===size).usd;
      addToCart(p.id, p.name[lang], size, parseInt(q.textContent,10), {usd:unit,kgs:kgs(unit)});
    };
    card.appendChild(add);

    root.appendChild(card);
  });
}

function addToCart(id, name, size, qty, price){
  const key = id+"-"+size;
  const i = cart.findIndex(x=>x.key===key);
  if(i>-1){ cart[i].qty += qty; } else { cart.push({key,id,name,size,qty,price}); }
  updateCart();
}

function updateCart(){
  const items = document.getElementById("cartItems");
  const count = document.getElementById("cartCount");
  items.innerHTML = "";
  let totUSD=0, totKGS=0;
  cart.forEach((it,idx)=>{
    const row = document.createElement("div"); row.className="row";
    row.innerHTML = `<span>${it.name} ${it.size} ml x${it.qty} (${it.price.kgs} —Å–æ–º / $${money(it.price.usd)})</span>`;
    const rm = document.createElement("button"); rm.className="btn"; rm.textContent=T.remove[lang]; rm.onclick=()=>{ cart.splice(idx,1); updateCart(); };
    row.appendChild(rm);
    items.appendChild(row);
    totUSD += it.price.usd*it.qty; totKGS += it.price.kgs*it.qty;
  });
  document.getElementById("totals").textContent = `TOTAL: ${totKGS} —Å–æ–º / $${money(totUSD)}`;
  if(cart.length>0){ count.style.display="inline-block"; count.textContent = cart.reduce((a,c)=>a+c.qty,0); }
  else { count.style.display="none"; }
}

function openCart(){ document.getElementById("cart").classList.add("open"); }
function closeCart(){ document.getElementById("cart").classList.remove("open"); }
function toggleCart(){ document.getElementById("cart").classList.toggle("open"); }

/* Confirmar pedido: env√≠a a Sheets y a WhatsApp, y cierra el carrito */
function confirmOrder(){
  if(cart.length===0){ alert(T.empty_cart[lang] + " ‚Äî TOTAL: $0 / 0 —Å–æ–º"); return; }

  let msg = "üßæ " + T.cart[lang] + ":\n";
  let totUSD=0, totKGS=0;
  cart.forEach(it=>{
    const subU = it.price.usd*it.qty, subK = it.price.kgs*it.qty;
    msg += `‚Ä¢ ${it.name} (${it.size} ml) x${it.qty} = ${subK} —Å–æ–º / $${money(subU)}\n`;
    totUSD += subU; totKGS += subK;
  });
  msg += `\nTOTAL: ${totKGS} —Å–æ–º / $${money(totUSD)}`;

  const orderId = genOrderId();
  msg += `\n\nID: ${orderId}`;

  const payload = {
    orderId, alive:true, version:"orders-v3-clean",
    to: PHONE_KG + "," + PHONE_US,
    totalUSD: Number(money(totUSD)),
    totalKGS: Number(totKGS),
    currency:"USD/KGS",
    lang,
    items: cart.map(it=>({id:it.id,name:it.name,ml:Number(it.size),qty:Number(it.qty),usd:Number(it.price.usd),kgs:Number(it.price.kgs)})),
    created_at: new Date().toISOString()
  };
  sendToSheets(payload);

  const enc = encodeURIComponent(msg);
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const urlKG = isMobile ? `whatsapp://send?phone=${PHONE_KG}&text=${enc}` : `https://wa.me/${PHONE_KG}?text=${enc}`;
  window.open(urlKG,"_blank");
  const urlUS = isMobile ? `whatsapp://send?phone=${PHONE_US}&text=${enc}` : `https://wa.me/${PHONE_US}?text=${enc}`;
  setTimeout(()=>window.open(urlUS,"_blank"),500);

  cart = []; updateCart(); closeCart();
}

/* ================== INIT (robusto) ================== */
// Desregistra SW viejos para evitar pantallas en blanco por cach√©
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));
}

window.addEventListener("load", () => {
  try{
    // Idioma por defecto (ky)
    const sel = document.getElementById("lang");
    sel.value = lang;
    sel.onchange = (e)=>{ lang=e.target.value; localStorage.setItem("capi_lang",lang); i18n(); renderProducts(); updateCart(); };

    // Botones carrito
    document.getElementById("btnCart").onclick = openCart;
    document.getElementById("closeCart").onclick = closeCart;
    document.getElementById("confirm").onclick = confirmOrder;

    // Cierre al hacer click fuera (backdrop) y con Escape
    document.getElementById("backdrop").onclick = closeCart;
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeCart(); });

    // Pintar
    i18n(); renderProducts(); updateCart();

    // (Opcional) ping de salud
    fetch(SHEETS_WEBAPP_URL).catch(()=>{});
  }catch(e){
    console.error("Init error:", e);
    document.getElementById("products").innerHTML = "<div class='card'>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É / Vuelva a cargar la p√°gina.</div>";
  }
});
</script>
</body>
</html>

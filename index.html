<!DOCTYPE html>
<html lang="ky">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CAPI ‚Äî Productos 100% Natural</title>
  <meta name="theme-color" content="#d86916"/>
  <style>
    :root{--mango:#f3a21b;--honey:#d86916;--ink:#1e293b;--muted:#64748b;--card:#fff;--bg:#fff7ec}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,#fff,var(--bg))}
    .topbar{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:rgba(255,255,255,.88);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #ffe1ad}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:radial-gradient(100% 100% at 30% 30%, var(--mango), var(--honey));box-shadow:0 6px 20px rgba(216,105,22,.25)}
    .brand-name{font-weight:800} .slogan{font-size:12px;color:var(--muted)}
    .controls{display:flex;align-items:center;gap:8px}
    select,.btn{border:1px solid #ffd489;background:#fff;color:var(--ink);padding:8px 10px;border-radius:12px;font:inherit}
    .btn.mango{background:linear-gradient(180deg,#fff8eb,#ffe3b3)}
    .shell{max-width:1100px;margin:0 auto;padding:16px}
    .notice{margin:10px 16px;padding:10px 12px;border:1px dashed #ffd08a;border-radius:12px;background:#fff7e8;color:#6a3c13;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #ffe1ad;border-radius:18px;padding:14px;box-shadow:0 6px 16px rgba(243,162,27,.08);display:flex;flex-direction:column;gap:10px}
    .qty{display:flex;align-items:center;gap:8px}.qty .q{min-width:22px;text-align:center;display:inline-block}
    .popup{position:fixed;inset:0;display:none}.popup.open{display:block}
    .panel{position:absolute;right:0;top:0;bottom:0;width:min(480px,92%);background:#fff;border-left:1px solid #ffe1ad;box-shadow:-6px 0 20px rgba(0,0,0,.12);display:flex;flex-direction:column;padding:12px}
    .panel h2{margin:10px 0} .row{display:flex;justify-content:space-between;border:1px solid #ffe1ad;border-radius:12px;padding:8px;margin:6px 0}
    .badge{background:#dc2626;color:#fff;border-radius:999px;min-width:18px;padding:2px 6px;font-size:12px}
    .foot{color:var(--muted);text-align:center;padding:16px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="brand-name">CAPI</div>
        <div class="slogan" id="slogan">100% —Ç–∞–±–∏–≥—ã–π –ø—Ä–æ–¥—É–∫—Ç—ã–ª–∞—Ä</div>
      </div>
    </div>
    <div class="controls">
      <label for="lang">üåê</label>
      <select id="lang" aria-label="Language">
        <option value="ky">üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞</option>
        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
        <option value="es" selected>üá™üá∏ Espa√±ol</option>
        <option value="en">üá¨üáß English</option>
      </select>
      <button id="btnCart" class="btn mango">üõí <span id="cartTxt">Tu carrito</span> <span id="cartCount" class="badge" style="display:none">0</span></button>
    </div>
  </header>

  <main class="shell">
    <div class="notice" id="pricesNote">Precios en USD y KGS. Cambia el tama√±o para ver el precio.</div>
    <section id="products" class="grid"></section>
  </main>

  <!-- Cart -->
  <aside id="cart" class="popup" role="dialog" aria-modal="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="cartTitle">Tu carrito</h2>
        <button class="btn" id="closeCart">‚úï</button>
      </div>
      <div id="cartItems"></div>
      <div id="totals" style="margin-top:8px;font-weight:800">TOTAL: 0 —Å–æ–º / $0.00</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="confirm" class="btn mango">‚úÖ Confirmar pedido</button>
        <button id="retry" class="btn">‚Üª</button>
      </div>
      <small id="postNote" style="color:#64748b"></small>
    </div>
  </aside>

  <footer class="foot">¬© CAPI</footer>

  <script>
    // -------- CONFIG --------
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwh0COks2zW82RXr9_3li-XNuixON0yI5wMOoNps74HC4z6eitTW_NEgD7CYWmwN7nX/exec";
    const PHONE_KG = "996559500551";
    const PHONE_US = "17866514487";
    const EXCHANGE_KGS_PER_USD = 89;

    // Mata cualquier SW viejo para evitar pantallas en blanco por cach√©
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
    }

    // -------- DATA --------
    const t = {
      title:       { ky:"–ü—Ä–æ–¥—É–∫—Ü–∏—è–ª–∞—Ä 100% —Ç–∞–±–∏–≥—ã–π", ru:"–ü—Ä–æ–¥—É–∫—Ü–∏—è 100% –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è", es:"Productos 100% Natural", en:"100% Natural Products" },
      prices_note: { ky:"–ë–∞–∞–ª–∞—Ä USD –∂–∞–Ω–∞ KGS –º–µ–Ω–µ–Ω. ”®–ª—á”©–º–¥“Ø ”©–∑–≥”©—Ä—Ç“Ø–ø –±–∞–∞–Ω—ã –∫”©—Ä“Ø“£“Ø–∑.", ru:"–¶–µ–Ω—ã –≤ USD –∏ —Å–æ–º–∞—Ö. –ú–µ–Ω—è–π—Ç–µ –æ–±—ä—ë–º, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ü–µ–Ω—É.", es:"Precios en USD y KGS. Cambia el tama√±o para ver el precio.", en:"Prices in USD and KGS. Change size to see price." },
      cart:        { ky:"–°–µ–±–µ—Ç", ru:"–ö–æ—Ä–∑–∏–Ω–∞", es:"Tu carrito", en:"Your cart" },
      empty_cart:  { ky:"–°–µ–±–µ—Ç –±–æ—à", ru:"–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞", es:"El carrito est√° vac√≠o", en:"Cart is empty" },
      add:         { ky:"–°–µ–±–µ—Ç–∫–µ –∫–æ—à—É—É", ru:"–í –∫–æ—Ä–∑–∏–Ω—É", es:"Agregar al carrito", en:"Add to cart" },
      remove:      { ky:"”®—á“Ø—Ä“Ø“Ø", ru:"–£–¥–∞–ª–∏—Ç—å", es:"Eliminar", en:"Remove" },
    };
    const products = [
      { id:"honey", name:{ky:"–ë–∞–ª",ru:"–ú—ë–¥",es:"Miel",en:"Honey"}, sizes:[{ml:230,usd:3.0},{ml:500,usd:5.0},{ml:1000,usd:10.0}] },
      { id:"mango", name:{ky:"–ñ–∞—à –º–∞–Ω–≥–æ –∞—á—É—É —Å–æ—É—Å—É",ru:"–û—Å—Ç—Ä—ã–π —Å–æ—É—Å –∏–∑ –∑–µ–ª—ë–Ω–æ–≥–æ –º–∞–Ω–≥–æ",es:"Salsa Picante de Mango Verde",en:"Green Mango Hot Sauce"}, sizes:[{ml:230,usd:3.5},{ml:500,usd:8.0},{ml:1000,usd:20.0}] }
    ];
    function kgs(usd){ return Math.round(usd*EXCHANGE_KGS_PER_USD); }
    function money(n){ return (Math.round(n*100)/100).toFixed(2); }

    // -------- STATE --------
    let cart = [];
    let lang = (localStorage.getItem("capi_lang") || "es");

    // -------- UI --------
    function i18n(){
      document.getElementById("slogan").textContent = t.title[lang];
      document.getElementById("pricesNote").textContent = t.prices_note[lang];
      document.getElementById("cartTxt").textContent = t.cart[lang];
      document.getElementById("cartTitle").textContent = t.cart[lang];
    }

    function renderProducts(){
      const root = document.getElementById("products");
      root.innerHTML = "";
      products.forEach(p=>{
        const card = document.createElement("div"); card.className="card";
        const h3 = document.createElement("h3"); h3.textContent = p.name[lang]; card.appendChild(h3);

        const sel = document.createElement("select");
        p.sizes.forEach((s,i)=>{ const o=document.createElement("option"); o.value=s.ml; o.textContent=`${s.ml} ml`; sel.appendChild(o); if(i===0) sel.value=s.ml; });
        card.appendChild(sel);

        const price = document.createElement("div");
        price.innerHTML = `Precio: ${kgs(p.sizes[0].usd)} —Å–æ–º / $${money(p.sizes[0].usd)}`;
        card.appendChild(price);

        sel.onchange = ()=> {
          const s = p.sizes.find(x=>x.ml==sel.value);
          price.innerHTML = `Precio: ${kgs(s.usd)} —Å–æ–º / $${money(s.usd)}`;
        };

        const controls = document.createElement("div"); controls.className="qty";
        const dec = document.createElement("button"); dec.textContent="‚àí";
        const q = document.createElement("span"); q.className="q"; q.textContent="1";
        const inc = document.createElement("button"); inc.textContent="+";
        dec.onclick = ()=>{ q.textContent = Math.max(1, parseInt(q.textContent)-1); };
        inc.onclick = ()=>{ q.textContent = parseInt(q.textContent)+1; };
        controls.append(dec,q,inc); card.appendChild(controls);

        const add = document.createElement("button"); add.className="btn"; add.textContent = t.add[lang];
        add.onclick = ()=>{
          const size = parseInt(sel.value,10);
          const unit = p.sizes.find(x=>x.ml===size).usd;
          addToCart(p.id, p.name[lang], size, parseInt(q.textContent,10), {usd:unit,kgs:kgs(unit)});
        };
        card.appendChild(add);

        root.appendChild(card);
      });
    }

    function addToCart(id, name, size, qty, price){
      const key = id+"-"+size;
      const i = cart.findIndex(x=>x.key===key);
      if(i>-1){ cart[i].qty += qty; } else { cart.push({key,id,name,size,qty,price}); }
      updateCart();
    }

    function updateCart(){
      const items = document.getElementById("cartItems");
      const count = document.getElementById("cartCount");
      items.innerHTML = "";
      let totUSD=0, totKGS=0;
      cart.forEach((it,idx)=>{
        const row = document.createElement("div"); row.className="row";
        row.innerHTML = `<span>${it.name} ${it.size} ml x${it.qty} (${it.price.kgs} —Å–æ–º / $${money(it.price.usd)})</span>`;
        const rm = document.createElement("button"); rm.className="btn"; rm.textContent=t.remove[lang]; rm.onclick=()=>{ cart.splice(idx,1); updateCart(); };
        row.appendChild(rm);
        items.appendChild(row);
        totUSD += it.price.usd*it.qty; totKGS += it.price.kgs*it.qty;
      });
      document.getElementById("totals").textContent = `TOTAL: ${totKGS} —Å–æ–º / $${money(totUSD)}`;
      if(cart.length>0){ count.style.display="inline-block"; count.textContent = cart.reduce((a,c)=>a+c.qty,0); }
      else { count.style.display="none"; }
    }

    function toggleCart(open){
      const c = document.getElementById("cart");
      if(open===true) c.classList.add("open");
      else if(open===false) c.classList.remove("open");
      else c.classList.toggle("open");
    }

    function genOrderId(){ return "CAPI-" + Math.random().toString(16).slice(2,10).toUpperCase(); }

    function sendToSheets(payload){
      try{
        fetch(SHEETS_WEBAPP_URL, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) });
      }catch(_){}
    }

    function confirmOrder(){
      if(cart.length===0){ alert(t.empty_cart[lang] + " ‚Äî TOTAL: $0 / 0 —Å–æ–º"); return; }
      // Mensaje WA
      let msg = "üßæ " + t.cart[lang] + ":\n";
      let totUSD=0, totKGS=0;
      cart.forEach(it=>{
        const subU = it.price.usd*it.qty, subK = it.price.kgs*it.qty;
        msg += `‚Ä¢ ${it.name} (${it.size} ml) x${it.qty} = ${subK} —Å–æ–º / $${money(subU)}\n`;
        totUSD += subU; totKGS += subK;
      });
      msg += `\nTOTAL: ${totKGS} —Å–æ–º / $${money(totUSD)}`;

      const orderId = genOrderId();
      msg += `\n\nID: ${orderId}`;

      // Payload para Sheets
      const payload = {
        orderId, alive:true, version:"orders-v3-clean",
        to: PHONE_KG + "," + PHONE_US,
        totalUSD: Number(money(totUSD)),
        totalKGS: Number(totKGS),
        currency:"USD/KGS",
        lang,
        items: cart.map(it=>({id:it.id,name:it.name,ml:Number(it.size),qty:Number(it.qty),usd:Number(it.price.usd),kgs:Number(it.price.kgs)})),
        created_at: new Date().toISOString()
      };
      sendToSheets(payload);

      // Abrir WhatsApp a ambos
      const enc = encodeURIComponent(msg);
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const urlKG = isMobile ? `whatsapp://send?phone=${PHONE_KG}&text=${enc}` : `https://wa.me/${PHONE_KG}?text=${enc}`;
      window.open(urlKG,"_blank");
      const urlUS = isMobile ? `whatsapp://send?phone=${PHONE_US}&text=${enc}` : `https://wa.me/${PHONE_US}?text=${enc}`;
      setTimeout(()=>window.open(urlUS,"_blank"),500);

      cart = []; updateCart(); toggleCart(false);
    }

    // -------- INIT (robusto) --------
    window.addEventListener("load", () => {
      try{
        // Idioma
        const sel = document.getElementById("lang");
        sel.value = lang;
        sel.onchange = (e)=>{ lang=e.target.value; localStorage.setItem("capi_lang",lang); i18n(); renderProducts(); updateCart(); };

        // Botones carrito
        document.getElementById("btnCart").onclick = ()=>toggleCart(true);
        document.getElementById("closeCart").onclick = ()=>toggleCart(false);
        document.getElementById("confirm").onclick = confirmOrder;
        document.getElementById("retry").onclick = ()=>alert("Reintento no necesario en este modo.");

        // Pintar
        i18n(); renderProducts(); updateCart();

        // Ping de salud (opcional)
        fetch(SHEETS_WEBAPP_URL+"?route=health").catch(()=>{});
      }catch(e){
        console.error("Init error:", e);
        // fallback m√≠nimo para que no quede en blanco
        document.getElementById("products").innerHTML = "<div class='card'>Recarga la p√°gina. Si persiste, borra cach√© del navegador.</div>";
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ky">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CAPIFAN ‚Äî —Ç–∞–±–∏—è—Ç—Ç–∞–Ω —Å–∏–∑–¥–∏–Ω –¥–∞—Å—Ç–æ—Ä–∫–æ–Ω—É“£—É–∑–≥–∞</title>
  <meta name="theme-color" content="#d86916"/>
  <link rel="manifest" href="manifest.json?v=2">

  <!-- iOS / iPadOS app icon -->
  <link rel="apple-touch-icon" sizes="120x120" href="icons/ios-120x120.png?v=2">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/ios-180x180.png?v=2">
  <link rel="apple-touch-icon" sizes="1024x1024" href="icons/ios-1024x1024.png?v=2">

  <!-- PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <style>
    :root{--mango:#f3a21b;--honey:#d86916;--ink:#1e293b;--muted:#64748b;--card:#fff;--bg:#fff7ec}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,#fff,var(--bg))}
    .topbar{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:rgba(255,255,255,.88);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #ffe1ad}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:12px;background:radial-gradient(100% 100% at 30% 30%, var(--mango), var(--honey));box-shadow:0 6px 20px rgba(216,105,22,.25)}
    .brand-name{font-weight:800} .slogan{font-size:12px;color:var(--muted)}
    .controls{display:flex;align-items:center;gap:8px}
    select,.btn{border:1px solid #ffd489;background:#fff;color:var(--ink);padding:8px 10px;border-radius:12px;font:inherit}
    .btn.mango{background:linear-gradient(180deg,#fff8eb,#ffe3b3);font-weight:700;cursor:pointer}
    .shell{max-width:1100px;margin:0 auto;padding:16px}
    .notice{margin:10px 16px;padding:10px 12px;border:1px dashed #ffd08a;border-radius:12px;background:#fff7e8;color:#6a3c13;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #ffe1ad;border-radius:18px;padding:14px;box-shadow:0 6px 16px rgba(243,162,27,.08);display:flex;flex-direction:column;gap:10px}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:12px;border:1px solid #ffe1ad}
    .qty{display:flex;align-items:center;gap:8px}.qty .q{min-width:22px;text-align:center;display:inline-block}

    /* ===== CARRITO (bottom sheet) ===== */
    .popup{position:fixed; inset:0; z-index:1000; display:block; pointer-events:none;}
    .popup.open{ pointer-events:auto; }
    .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.35); opacity:0; transition:opacity .2s ease;}
    .popup.open .backdrop{ opacity:1; }
    .panel{
      position:fixed; left:0; right:0; bottom:0;
      top: calc(env(safe-area-inset-top, 0px) + 64px);
      background:#fff; border-top-left-radius:18px; border-top-right-radius:18px;
      border-left:0; box-shadow:0 -10px 30px rgba(0,0,0,.15);
      width:auto; max-height: calc(100dvh - env(safe-area-inset-top) - 64px);
      transform: translateY(100%); transition: transform .25s ease;
      display:flex; flex-direction:column;
      padding: calc(12px + env(safe-area-inset-top, 0px)) 16px calc(14px + env(safe-area-inset-bottom, 0px));
      overflow:hidden;
    }
    .popup.open .panel{ transform: translateY(0); }
    .panel #cartItems{ flex:1; overflow:auto; -webkit-overflow-scrolling:touch; }
    body.no-scroll{ overflow:hidden; height:100dvh; }
    /* ===== FIN CARRITO ===== */

    .badge{background:#dc2626;color:#fff;border-radius:999px;min-width:18px;padding:2px 6px;font-size:12px}
    .foot{color:var(--muted);text-align:center;padding:16px}

    /* Bot√≥n eliminar del carrito */
    .btn-remove{
      background: linear-gradient(180deg, rgba(255, 0, 0, 0.12), rgba(255, 0, 0, 0.18));
      border: 1px solid rgba(255, 0, 0, 0.25);
      color: #000; font-weight: 600; cursor: pointer;
      transition: transform 0.05s ease, background 0.2s ease;
      border-radius: 12px; padding: 8px 10px;
    }
    .btn-remove:hover{ background: linear-gradient(180deg, rgba(255,0,0,.18), rgba(255,0,0,.25)); }
    .btn-remove:active{ transform: scale(0.97); }

    /* Bot√≥n cerrar carrito */
    #closeCart{ background: linear-gradient(180deg, #d1f7d1, #a6e3a6); border: 1px solid #6ccf6c; color:#000; font-weight:700; border-radius:12px; padding:8px 10px; }
    #closeCart:hover{ background: linear-gradient(180deg, #a6e3a6, #8cd88c); }
  </style>

  <!-- OVERRIDE im√°genes -->
  <style id="imgfix-override">
    #product-list .product img,
    .product img,
    img.product-image {
      height: 320px !important;
      width: 100% !important;
      object-fit: contain !important;
      display: block !important;
      margin: 0 auto 10px !important;
      border-radius: 12px !important;
      border: 1px solid #ffe1ad !important;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="brand-name">CAPIFAN</div>
        <div class="slogan" id="slogan">—Ç–∞–±–∏—è—Ç—Ç–∞–Ω —Å–∏–∑–¥–∏–Ω –¥–∞—Å—Ç–æ—Ä–∫–æ–Ω—É“£—É–∑–≥–∞</div>
      </div>
    </div>
    <div class="controls">
      <label for="lang">üåê</label>
      <select id="lang" aria-label="Language">
        <option value="ky" selected>üá∞üá¨ –öY</option>
        <option value="ru">üá∑üá∫ RU</option>
        <option value="es">üá™üá∏ ES</option>
        <option value="en">üá¨üáß EN</option>
      </select>
      <button id="btnCart" class="btn mango">üõí <span id="cartTxt" data-i18n="your_cart">Your cart</span> <span id="cartCount" class="badge" style="display:none">0</span></button>
    </div>
  </header>

  <main class="shell">
    <div class="notice" id="pricesNote">–ë–∞–∞–ª–∞—Ä USD –∂–∞–Ω–∞ KGS –º–µ–Ω–µ–Ω. ”®–ª—á”©–º–¥“Ø ”©–∑–≥”©—Ä—Ç“Ø–ø –±–∞–∞–Ω—ã –∫”©—Ä“Ø“£“Ø–∑.</div>
    <section id="products" class="grid"></section>
  </main>

  <!-- Cart -->
<aside id="cart" class="popup" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
  <div class="backdrop" id="backdrop"></div>
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 id="cartTitle">–°–µ–±–µ—Ç</h2>
      <button class="btn" id="closeCart" aria-label="Cerrar">‚úï</button>
    </div>
    <div id="cartItems"></div>
    <div id="totals" style="margin-top:8px;font-weight:800">TOTAL: 0 —Å–æ–º / $0.00</div>

    <!-- ‚úÖ Campos de cliente -->
    <div id="customerFields" style="margin-top:10px; display:flex; flex-direction:column; gap:6px">
      <input id="customerName" type="text" placeholder="Name" required
             style="padding:8px; border:1px solid #ccc; border-radius:8px;">
      <input id="customerPhone" type="tel" placeholder="Phone" required
             style="padding:8px; border:1px solid #ccc; border-radius:8px;">
      <input id="customerEmail" type="email" placeholder="Email" required
             style="padding:8px; border:1px solid #ccc; border-radius:8px;">
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="confirm" class="btn mango">‚úÖ –ë—É–π—Ä—É—Ç–º–∞–Ω—ã —Ç–∞—Å—Ç—ã–∫—Ç–æ–æ</button>
    </div>
    <small id="postNote" style="color:#64748b"></small>
  </div>
</aside>

  <footer class="foot">¬© 2025 CAPIFAN ‚Äì elcapiproduct@gmail.com</footer>

  <script>
  /* ================== CONFIG ================== */
  const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzd7c-3ydfb-HD2mMvYVDxOIc6rgEbcbYktfU5z6WCSDXdGItuiU9Vx8K6onKh0_8tw/exec";
  const PHONE_KG = "996559500551";
  const PHONE_US = "17866514487";

  /* Idioma por defecto: KY */
  let currentLang = 'ky';

  /* ================== DATA ================== */
  const products = [
    { id:"honey", sizes: { "350":{kgs:349,usd:4.0}, "500":{kgs:550,usd:6.3}, "1000":{kgs:874,usd:10.0} } },
    { id:"mango_sauce", sizes: { "350":{kgs:349,usd:4.0}, "500":{kgs:787,usd:9.0}, "1000":{kgs:1748,usd:20.0} } }
  ];

  const translations = {
    honey: { ky:"—Ç–∞–∑–∞ –ë–∞–ª Issyk-Kul", ru:"–ß–∏—Å—Ç—ã–π –º–µ–¥ Issyk-Kul", es:"Miel Pura Issyk-Kul", en:"Pure Honey Issyk-Kul" },
    mango_sauce: { ky:"–ê—á—ã—Ç—É—É –º–∞–Ω–≥–æ —Å–æ—É—Å—É", ru:"–û—Å—Ç—Ä—ã–π —Å–æ—É—Å –∏–∑ –º–∞–Ω–≥–æ", es:"Salsa Picante de Mango Verde", en:"Green Mango Hot Sauce" },
    slogan: { ky:"100% —Ç–∞–±–∏–≥—ã–π –ø—Ä–æ–¥—É–∫—Ç—ã–ª–∞—Ä", ru:"100% –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã", es:"Productos 100% Naturales", en:"100% Natural Products" },
    price: { ky:"–ë–∞–∞—Å—ã:", ru:"–¶–µ–Ω–∞:", es:"Precio:", en:"Price:" },
    confirm_order: { ky:"–ë—É–π—Ä—É—Ç–º–∞–Ω—ã —ã—Ä–∞—Å—Ç–æ–æ", ru:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑", es:"Confirmar pedido", en:"Confirm order" },
    your_cart: { ky:"–°–µ–±–µ—Ç–∏“£–∏–∑", ru:"–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞", es:"Tu carrito", en:"Your cart" },
    add_to_cart: { ky:"–°–µ–±–µ—Ç–∫–µ –∫–æ—à—É—É", ru:"–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É", es:"Agregar al carrito", en:"Add to cart" },
    remove: { ky:"”®—á“Ø—Ä“Ø“Ø", ru:"–£–¥–∞–ª–∏—Ç—å", es:"Eliminar", en:"Remove" },
    cart_empty: { ky:"–°–µ–±–µ—Ç–∏“£–∏–∑ –±–æ—à", ru:"–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è", es:"Tu carrito est√° vac√≠o", en:"Your cart is empty" },

    required_fields: {
      ky: "–¢–∞–ª–∞–ø –∫—ã–ª—ã–Ω–≥–∞–Ω —Ç–∞–ª–∞–∞–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑ (–∞—Ç—ã, —Ç–µ–ª–µ—Ñ–æ–Ω, email).",
      ru: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, email).",
      es: "Debe completar los campos obligatorios (nombre, tel√©fono, email).",
      en: "Please fill in the required fields (name, phone, email)."
    },

    ph_name:  { ky:"–ê—Ç—ã“£—ã–∑", ru:"–ò–º—è", es:"Nombre",   en:"Name"  },
    ph_phone: { ky:"–¢–µ–ª–µ—Ñ–æ–Ω", ru:"–¢–µ–ª–µ—Ñ–æ–Ω", es:"Tel√©fono", en:"Phone" },
    ph_email: { ky:"–≠–ª–µ–∫—Ç—Ä–æ–Ω–¥—É–∫ –ø–æ—á—Ç–∞", ru:"–≠–ª. –ø–æ—á—Ç–∞", es:"Email", en:"Email" }
  };

  /* ================== STATE ================== */
  let cart = [];

  /* ================== I18N ================== */
  function setLanguage(lang){
    currentLang = lang;
    document.documentElement.lang = lang;

    // Textos
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if (translations[key] && translations[key][lang]) el.textContent = translations[key][lang];
    });

    // Placeholders
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
      const key = el.getAttribute('data-i18n-ph');
      if (translations[key] && translations[key][lang]) el.placeholder = translations[key][lang];
    });

    renderProducts();
    renderCart();
  }

  /* ================== PRODUCTS ================== */
  function renderProducts() {
    const list = document.getElementById("products");
    list.innerHTML = "";
    products.forEach(product => {
      const div = document.createElement("div");
      div.className = "product";

      const name = translations[product.id][currentLang];

      const img = document.createElement("img");
      img.src = product.id === "honey" ? "honey_logo.png" : "mango_logo.png";
      img.alt = name;
      img.className = "product-image";
      div.appendChild(img);

      const title = document.createElement("h2");
      title.textContent = name;
      div.appendChild(title);

      const selector = document.createElement("select");
      selector.className = "size-selector";
      for (let size in product.sizes) {
        const opt = document.createElement("option");
        opt.value = size;
        opt.textContent = size + " ml";
        selector.appendChild(opt);
      }
      div.appendChild(selector);

      const priceLabel = document.createElement("p");
      priceLabel.className = "price-label";
      const firstSize = Object.keys(product.sizes)[0];
      priceLabel.textContent = translations["price"][currentLang] + " " +
        product.sizes[firstSize].kgs + " —Å–æ–º / $" + product.sizes[firstSize].usd;
      div.appendChild(priceLabel);

      selector.onchange = () => {
        const size = selector.value;
        const price = product.sizes[size];
        priceLabel.textContent = translations["price"][currentLang] + " " +
          price.kgs + " —Å–æ–º / $" + price.usd;
      };

      const controls = document.createElement("div");
      controls.className = "qty";
      controls.innerHTML = `
        <button class="decrease">‚àí</button>
        <span class="quantity">1</span>
        <button class="increase">+</button>
      `;
      div.appendChild(controls);

      controls.querySelector(".decrease").onclick = () => {
        let q = controls.querySelector(".quantity");
        let val = parseInt(q.textContent);
        if (val > 1) q.textContent = val - 1;
      };
      controls.querySelector(".increase").onclick = () => {
        let q = controls.querySelector(".quantity");
        q.textContent = parseInt(q.textContent) + 1;
      };

      const addBtn = document.createElement("button");
      addBtn.className = "btn mango";
      addBtn.textContent = translations["add_to_cart"][currentLang];
      addBtn.onclick = () => {
        const size = selector.value;
        const quantity = parseInt(controls.querySelector(".quantity").textContent);
        const name = translations[product.id][currentLang];
        const price = product.sizes[size];
        addToCart(product.id, name, size, quantity, price);
      };
      div.appendChild(addBtn);

      list.appendChild(div);
    });
  }

  /* ================== CART ================== */
  function addToCart(id, name, size, quantity, price) {
    const idx = cart.findIndex(it => it.id === id && it.size === size);
    if (idx > -1) cart[idx].quantity += quantity;
    else cart.push({ id, name, size, quantity, price });
    renderCart();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function renderCart() {
    const list = document.getElementById("cartItems");
    list.innerHTML = "";
    let totalKGS = 0, totalUSD = 0;

    cart.forEach((item, index) => {
      const row = document.createElement("div");
      const icon = item.id === "honey" ? "üçØ" : "üå∂Ô∏è";
      row.innerHTML = `
        <span>${icon} ${item.name} ${item.size} ml x${item.quantity}
          (${item.price.kgs} —Å–æ–º / $${item.price.usd})
        </span>
      `;
      const rm = document.createElement("button");
      rm.className = "btn-remove";
      rm.textContent = "üóë";
      rm.onclick = () => removeItem(index);
      row.appendChild(rm);
      list.appendChild(row);

      totalKGS += item.quantity * item.price.kgs;
      totalUSD += item.quantity * item.price.usd;
    });

    document.getElementById("totals").innerHTML =
      `TOTAL: ${totalKGS} —Å–æ–º / $${totalUSD.toFixed(2)}`;

    // badge
    const badge = document.getElementById("cartCount");
    const count = cart.reduce((s,i)=>s+i.quantity,0);
    if (count>0){ badge.style.display="inline-block"; badge.textContent = count; }
    else { badge.style.display="none"; }
  }

  function openCart(){
    document.getElementById("cart").classList.add("open");
    document.body.classList.add("no-scroll");
  }
  function closeCart(){
    document.getElementById("cart").classList.remove("open");
    document.body.classList.remove("no-scroll");
  }

  /* ================== CONFIRM ================== */
  let sending = false;
  function genOrderId(){ return "CAPIFAN-" + Math.random().toString(16).slice(2,10).toUpperCase(); }

  function confirmOrder(){
    if (sending) return;
    if (cart.length === 0){
      alert(translations.cart_empty[currentLang]);
      return;
    }

    const customerName  = document.getElementById("customerName").value.trim();
    const customerPhone = document.getElementById("customerPhone").value.trim();
    const customerEmail = document.getElementById("customerEmail").value.trim();

    if (!customerName || !customerPhone || !customerEmail){
      alert("‚ö†Ô∏è " + translations.required_fields[currentLang]);
      return;
    }

    sending = true;

    // Mensaje WhatsApp
    let msg = "üßæ CAPIFAN " + translations["your_cart"][currentLang] + ":\n";
    let totalKGS = 0, totalUSD = 0;
    cart.forEach(item=>{
      const subK = item.price.kgs * item.quantity;
      const subU = item.price.usd * item.quantity;
      msg += `‚Ä¢ ${item.name} (${item.size} ml) x${item.quantity} = ${subK} —Å–æ–º / $${subU.toFixed(2)}\n`;
      totalKGS += subK; totalUSD += subU;
    });
    msg += `\nTOTAL: ${totalKGS} —Å–æ–º / $${totalUSD.toFixed(2)}`;

    const orderId = genOrderId();
    msg += `\n\nID: ${orderId}`;

    // Payload a Sheets
    const payload = {
      orderId,
      alive: true,
      version: "orders-v4-clean+invoices",
      to: PHONE_KG + "," + PHONE_US,
      totalUSD: Number(totalUSD.toFixed(2)),
      totalKGS: Number(totalKGS),
      currency: "USD/KGS",
      lang: currentLang,
      items: cart.map(it=>({
        id: it.id, name: it.name, ml: Number(it.size),
        qty: Number(it.quantity), usd: Number(it.price.usd), kgs: Number(it.price.kgs)
      })),
      created_at: new Date().toISOString(),
      customer: customerName,
      phone: customerPhone,
      email: customerEmail,
      autoInvoice: true
    };

    // Enviar
    fetch(SHEETS_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).catch(()=>{});

    // WhatsApp
    const encoded = encodeURIComponent(msg);
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const urlKG = isMobile ? `whatsapp://send?phone=${PHONE_KG}&text=${encoded}` : `https://wa.me/${PHONE_KG}?text=${encoded}`;
    const urlUS = isMobile ? `whatsapp://send?phone=${PHONE_US}&text=${encoded}` : `https://wa.me/${PHONE_US}?text=${encoded}`;
    window.open(urlKG, "_blank");
    setTimeout(()=>window.open(urlUS, "_blank"), 500);

    // Reset
    cart = [];
    renderCart();
    closeCart();
    sending = false;
  }

  /* ================== INIT ================== */
  window.addEventListener("load", ()=>{
    // listeners
    document.getElementById("btnCart").onclick = openCart;
    document.getElementById("closeCart").onclick = closeCart;
    document.getElementById("backdrop").onclick = closeCart;
    document.getElementById("confirm").onclick = confirmOrder;
    document.getElementById("lang").onchange = (e)=> setLanguage(e.target.value);

    // iniciar
    setLanguage(currentLang);
    try{ fetch(SHEETS_WEBAPP_URL).catch(()=>{}); }catch(_){}
  });
  </script>
</body>
</html>
